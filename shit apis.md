



w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/activities/ShareInstagramStory.kt:86:42 'insertImage(ContentResolver!, Bitmap!, String!, String!): String!' is deprecated. Deprecated in Java



w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/activities/base/AbsSlidingMusicPanelActivity.kt:350:28 'getter for navigationBarColor: Int' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/activities/tageditor/AbsTagEditorActivity.kt:352:9 This is a delicate API and its use requires care. Make sure you fully read and understand documentation of the declaration that is marked as a delicate API.
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/activities/tageditor/AbsTagEditorActivity.kt:380:9 This is a delicate API and its use requires care. Make sure you fully read and understand documentation of the declaration that is marked as a delicate API.
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/adapter/base/AbsMultiSelectAdapter.kt:46:25 'setter for statusBarColor: Int' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/db/RoomMigrations.kt:7:26 The corresponding parameter in the supertype 'Migration' is named 'db'. This may cause problems when calling this function with named arguments.
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/dialogs/DeleteSongsDialog.kt:54:99 Parameter 'result' is never used, could be renamed to _
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/dialogs/SleepTimerDialog.kt:103:25 Condition 'previous != null' is always 'true'
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/extensions/ActivityExtensions.kt:32:33 'get(String!): Any?' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/extensions/ActivityExtensions.kt:37:25 'get(String!): Any?' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/extensions/ActivityExtensions.kt:42:33 'get(String!): Any?' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/extensions/ActivityThemeExtensions.kt:40:56 'FLAG_SHOW_WHEN_LOCKED: Int' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/extensions/ActivityThemeExtensions.kt:46:58 'FLAG_SHOW_WHEN_LOCKED: Int' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/extensions/ActivityThemeExtensions.kt:101:16 'setter for navigationBarColor: Int' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/extensions/ActivityThemeExtensions.kt:102:16 'setter for statusBarColor: Int' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/extensions/ActivityThemeExtensions.kt:123:29 'constructor TaskDescription(String!, Int, Int)' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/extensions/ActivityThemeExtensions.kt:130:44 'constructor TaskDescription(String!)' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/extensions/ActivityThemeExtensions.kt:203:53 'setter for statusBarColor: Int' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/extensions/ActivityThemeExtensions.kt:204:28 'setter for statusBarColor: Int' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/extensions/ActivityThemeExtensions.kt:218:16 'setter for navigationBarColor: Int' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/extensions/ActivityThemeExtensions.kt:220:16 'setter for navigationBarColor: Int' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/extensions/ActivityThemeExtensions.kt:227:16 'setter for navigationBarColor: Int' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/extensions/ActivityThemeExtensions.kt:240:16 'setter for statusBarColor: Int' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/extensions/FragmentExtensions.kt:51:28 'get(String!): Any?' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/extensions/FragmentExtensions.kt:56:28 'get(String!): Any?' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/fragments/library/LibraryFragment.kt:35:15 'onActivityCreated(Bundle?): Unit' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/fragments/library/LibraryFragment.kt:51:13 Variable 'color' is never used
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/fragments/lyrics/LyricsFragment.kt:216:17 This is a delicate API and its use requires care. Make sure you fully read and understand documentation of the declaration that is marked as a delicate API.
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/fragments/lyrics/LyricsFragment.kt:278:25 This is a delicate API and its use requires care. Make sure you fully read and understand documentation of the declaration that is marked as a delicate API.
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/fragments/other/UserInfoFragment.kt:263:53 'WEBP' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/fragments/player/PlayerAlbumCoverFragment.kt:71:24 'launchWhenStarted(suspend CoroutineScope.() -> Unit): Job' is deprecated. launchWhenStarted is deprecated as it can lead to wasted resources in some cases. Replace with suspending repeatOnLifecycle to run the block whenever the Lifecycle state is at least Lifecycle.State.STARTED.
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/fragments/player/PlayerAlbumCoverFragment.kt:206:27 Unnecessary safe call on a non-null receiver of type CoverLrcView
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/fragments/player/classic/ClassicPlayerFragment.kt:608:29 'getter for navigationBarColor: Int' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/fragments/player/fit/FitFragment.kt:76:13 Variable 'playerAlbumCoverFragment' is never used
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/fragments/player/normal/PlayerFragment.kt:123:13 Variable 'playerAlbumCoverFragment' is never used
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/fragments/playlists/PlaylistDetailsFragment.kt:147:25 This declaration is in a preview state and can be changed in a backwards-incompatible manner with a best-effort migration. Its usage should be marked with '@kotlinx.coroutines.FlowPreview' or '@OptIn(kotlinx.coroutines.FlowPreview::class)' if you accept the drawback of relying on preview API
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/fragments/settings/NotificationSettingsFragment.kt:24:38 Unnecessary safe call on a non-null receiver of type SharedPreferences
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/fragments/settings/NotificationSettingsFragment.kt:24:61 Unnecessary non-null assertion (!!) on a non-null receiver of type Boolean
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/fragments/settings/NowPlayingSettingsFragment.kt:37:60 Parameter 'newValue' is never used, could be renamed to _
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/glide/RetroGlideExtension.kt:91:9 Parameter 'forceDownload' is never used
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/helper/MusicPlayerRemote.kt:101:50 'getter for parent: Activity!' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/helper/SortOrder.kt:202:55 'Playlists' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/helper/SortOrder.kt:202:65 'DEFAULT_SORT_ORDER: String' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/preferences/NowPlayingScreenPreferenceDialog.kt:124:32 Parameter 'screen' is never used
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/repository/PlaylistSongsLoader.kt:20:42 'Playlists' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/repository/PlaylistSongsLoader.kt:20:52 'Members' is deprecated. Deprecated in Java
w: file:///data/data/com.termux/files/home/LifePlayer/app/src/main/java/zzh/lifeplayer/music/util/NavigationUtil.kt:79:26 'overridePendingTransition(Int, Int): Unit' is deprecated. Deprecated in Java


package zzh.lifeplayer.music.repository

import android.content.ContentResolver
import android.database.Cursor
import android.net.Uri
import android.provider.BaseColumns
import android.provider.MediaStore
import android.provider.MediaStore.Audio.AudioColumns
import zzh.lifeplayer.music.Constants
import zzh.lifeplayer.music.extensions.getInt
import zzh.lifeplayer.music.extensions.getLong
import zzh.lifeplayer.music.extensions.getString
import zzh.lifeplayer.music.extensions.getStringOrNull
import zzh.lifeplayer.music.model.Playlist
import zzh.lifeplayer.music.model.PlaylistSong
import zzh.lifeplayer.music.model.Song

interface PlaylistRepository {
    // ... 接口保持不变 ...
}

@Suppress("Deprecation")
class RealPlaylistRepository(
    private val contentResolver: ContentResolver
) : PlaylistRepository {

    // 定义常量替代弃用的 PlaylistsColumns
    companion object {
        private const val PLAYLIST_NAME = "name"
        private const val PLAYLIST_DATE_ADDED = "date_added"
        private const val PLAYLIST_DATE_MODIFIED = "date_modified"
        
        // 播放列表成员列名
        private const val MEMBER_AUDIO_ID = "audio_id"
        private const val MEMBER_PLAYLIST_ID = "playlist_id"
        private const val MEMBER_PLAY_ORDER = "play_order"
        private const val MEMBER_ID = "_id"
    }

    // 使用 MediaStore.Audio.Media.EXTERNAL_CONTENT_URI 替代弃用的 Playlists.EXTERNAL_CONTENT_URI
    private val playlistsUri: Uri = MediaStore.Audio.Playlists.EXTERNAL_CONTENT_URI

    // 创建播放列表成员的 URI
    private fun getPlaylistMembersUri(playlistId: Long): Uri {
        return playlistsUri.buildUpon()
            .appendPath(playlistId.toString())
            .appendPath("members")
            .build()
    }

    override fun playlist(cursor: Cursor?): Playlist {
        // ... 保持不变 ...
    }

    override fun playlist(playlistName: String): Playlist {
        return playlist(
            makePlaylistCursor("$PLAYLIST_NAME=?", arrayOf(playlistName))
    }

    override fun playlist(playlistId: Long): Playlist {
        return playlist(
            makePlaylistCursor("${BaseColumns._ID}=?", arrayOf(playlistId.toString()))
    }

    override fun searchPlaylist(query: String): List<Playlist> {
        return playlists(
            makePlaylistCursor("$PLAYLIST_NAME LIKE ?", arrayOf("%$query%"))
    }

    override fun playlists(): List<Playlist> {
        return playlists(makePlaylistCursor(null, null))
    }

    override fun playlists(cursor: Cursor?): List<Playlist> {
        // ... 保持不变 ...
    }

    override fun favoritePlaylist(playlistName: String): List<Playlist> {
        return playlists(
            makePlaylistCursor("$PLAYLIST_NAME=?", arrayOf(playlistName))
    }

    override fun deletePlaylist(playlistId: Long) {
        contentResolver.delete(
            playlistsUri,
            "${BaseColumns._ID}=?",
            arrayOf(playlistId.toString())
    }

    private fun getPlaylistFromCursorImpl(cursor: Cursor): Playlist {
        val id = cursor.getLong(0)
        val name = cursor.getString(1)
        return if (name != null) Playlist(id, name) else Playlist.empty
    }

    override fun playlistSongs(playlistId: Long): List<Song> {
        val songs = arrayListOf<Song>()
        if (playlistId == -1L) return songs
        
        val cursor = makePlaylistSongCursor(playlistId)
        cursor?.use {
            if (it.moveToFirst()) {
                do {
                    songs.add(getPlaylistSongFromCursorImpl(it, playlistId))
                } while (it.moveToNext())
            }
        }
        return songs
    }

    private fun getPlaylistSongFromCursorImpl(cursor: Cursor, playlistId: Long): PlaylistSong {
        return PlaylistSong(
            id = cursor.getLong(0),
            title = cursor.getString(1),
            trackNumber = cursor.getInt(2),
            year = cursor.getInt(3),
            duration = cursor.getLong(4),
            data = cursor.getString(5),
            dateModified = cursor.getLong(6),
            albumId = cursor.getLong(7),
            albumName = cursor.getString(8),
            artistId = cursor.getLong(9),
            artistName = cursor.getString(10),
            playlistId = playlistId,
            idInPlaylist = cursor.getLong(11),
            composer = cursor.getStringOrNull(12) ?: "",
            albumArtist = cursor.getStringOrNull(13)
        )
    }

    private fun makePlaylistCursor(
        selection: String?,
        values: Array<String>?
    ): Cursor? {
        return contentResolver.query(
            playlistsUri,
            arrayOf(
                BaseColumns._ID, // 0
                PLAYLIST_NAME   // 1
            ),
            selection,
            values,
            PLAYLIST_NAME // 按名称排序
        )
    }

    private fun makePlaylistSongCursor(playlistId: Long): Cursor? {
        return contentResolver.query(
            getPlaylistMembersUri(playlistId),
            arrayOf(
                MEMBER_AUDIO_ID,        // 0 -> audio_id
                AudioColumns.TITLE,      // 1
                AudioColumns.TRACK,      // 2
                AudioColumns.YEAR,       // 3
                AudioColumns.DURATION,   // 4
                Constants.DATA,          // 5
                AudioColumns.DATE_MODIFIED, // 6
                AudioColumns.ALBUM_ID,   // 7
                AudioColumns.ALBUM,      // 8
                AudioColumns.ARTIST_ID,  // 9
                AudioColumns.ARTIST,     // 10
                MEMBER_ID,               // 11 -> _id
                AudioColumns.COMPOSER,   // 12
                "album_artist"           // 13
            ),
            Constants.IS_MUSIC,
            null,
            MEMBER_PLAY_ORDER // 按播放顺序排序
        )
    }
}

